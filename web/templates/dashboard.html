<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Dating Bot - Admin Panel</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
            rel="stylesheet">
        <link href="/static/style.css" rel="stylesheet">
        <script src="https://telegram.org/js/telegram-web-app.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <style>
        .stat-card {
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .navbar-brand {
            font-weight: bold;
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
    </style>
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="/">üíò Dating Bot Admin</a>
                <button class="navbar-toggler" type="button"
                    data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link active" href="/">Dashboard</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/users">Users</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container mt-4">
            <div class="row mb-4">
                <div class="col-md-12">
                    <h1>üìä Bot Statistics</h1>
                    <p class="text-muted">Updated: {{ current_time }}</p>
                    <button class="btn btn-sm btn-outline-primary"
                        onclick="refreshStats()">üîÑ Refresh</button>
                </div>
            </div>

            <!-- User Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card stat-card text-center h-100">
                        <div class="card-body">
                            <h5 class="card-title text-primary">üë§ Users</h5>
                            <h2 class="text-primary">{{ user_stats.count or 0
                                }}</h2>
                            <p class="text-muted">Total registered</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card text-center h-100">
                        <div class="card-body">
                            <h5 class="card-title text-danger">üö´ Banned</h5>
                            <h2 class="text-danger">{{ user_stats.banned_count
                                or 0 }}</h2>
                            <p class="text-muted">Banned users</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card text-center h-100">
                        <div class="card-body">
                            <h5 class="card-title text-success">üìÇ Profiles</h5>
                            <h2 class="text-success">{{ profile_stats.count or 0
                                }}</h2>
                            <p class="text-muted">Profiles created</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card text-center h-100">
                        <div class="card-body">
                            <h5 class="card-title text-warning">üíò Matches</h5>
                            <h2 class="text-warning">{{ match_stats[0] or 0
                                }}</h2>
                            <p class="text-muted">Total matches</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Statistics -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>üë• Profile Statistics</h5>
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                <li
                                    class="list-group-item d-flex justify-content-between">
                                    <span>üôç‚Äç‚ôÇÔ∏è Male:</span>
                                    <strong>{{ profile_stats.male_count or 0
                                        }}</strong>
                                </li>
                                <li
                                    class="list-group-item d-flex justify-content-between">
                                    <span>üôç‚Äç‚ôÄÔ∏è Female:</span>
                                    <strong>{{ profile_stats.female_count or 0
                                        }}</strong>
                                </li>
                                <li
                                    class="list-group-item d-flex justify-content-between">
                                    <span>üîï Inactive:</span>
                                    <strong>{{ profile_stats.inactive_profile or
                                        0 }}</strong>
                                </li>
                                <li
                                    class="list-group-item d-flex justify-content-between">
                                    <span>üéÇ Average age:</span>
                                    <strong>{{
                                        "%.1f"|format(profile_stats.average_age)
                                        if profile_stats.average_age else "N/A"
                                        }}</strong>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>üìà Referral Statistics</h5>
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                <li
                                    class="list-group-item d-flex justify-content-between">
                                    <span>‚úâÔ∏è Total referrals:</span>
                                    <strong>{{ referral_stats.total_referrals or
                                        0 }}</strong>
                                </li>
                                <li
                                    class="list-group-item d-flex justify-content-between">
                                    <span>üåç Popular language:</span>
                                    <strong>{{ user_stats.most_popular_language
                                        or "N/A" }}</strong>
                                </li>
                                <li
                                    class="list-group-item d-flex justify-content-between">
                                    <span>üèôÔ∏è Popular city:</span>
                                    <strong>{{ profile_stats.most_popular_city
                                        or "N/A" }}</strong>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Registration Chart -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>üìÖ Registrations for the last 30 days</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="registrationChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Referral Sources -->
            {% if referral_stats.sources %}
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>üìä Referral Sources</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for source, count in
                                referral_stats.sources.items() %}
                                <div class="col-md-3 mb-3">
                                    <div class="text-center">
                                        <h6>{{ source }}</h6>
                                        <div class="progress">
                                            {% set percentage = (count /
                                            referral_stats.total_referrals *
                                            100) if
                                            referral_stats.total_referrals > 0
                                            else 0 %}
                                            <div class="progress-bar"
                                                role="progressbar"
                                                style="width: {{ percentage }}%">
                                                {{ count }} ({{
                                                "%.1f"|format(percentage) }}%)
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
        // –ì—Ä–∞—Ñ–∏–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π
        const registrationData = {{ registration_data | tojson }};

        const ctx = document.getElementById('registrationChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Object.keys(registrationData).sort(),
                datasets: [{
                    label: 'Registrations',
                    data: Object.keys(registrationData).sort().map(date => registrationData[date]),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function refreshStats() {
            location.reload();
        }

        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
        setInterval(refreshStats, 300000);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        {% if is_telegram_webapp %}
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram Web App
        if (window.Telegram && window.Telegram.WebApp) {
            const tg = window.Telegram.WebApp;

            // –†–∞—Å—à–∏—Ä—è–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
            tg.expand();

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç —Ç–µ–º—ã
            tg.setHeaderColor('#0d6efd');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ
            tg.ready();

            // –î–æ–±–∞–≤–ª—è–µ–º initData –∫–æ –≤—Å–µ–º –∑–∞–ø—Ä–æ—Å–∞–º
            const originalFetch = window.fetch;
            window.fetch = function(url, options = {}) {
                if (!url.includes('tgWebAppData') && tg.initData) {
                    const separator = url.includes('?') ? '&' : '?';
                    url += separator + 'tgWebAppData=' + encodeURIComponent(tg.initData);
                }
                return originalFetch(url, options);
            };
        }
        {% endif %}
    </script>
    </body>
</html>
